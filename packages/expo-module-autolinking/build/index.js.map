{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport Table from 'cli-table3';\nimport glob from 'fast-glob';\nimport findUp from 'find-up';\nimport fs from 'fs';\nimport os from 'os';\nimport path from 'path';\n\nimport {\n  AutolinkingPlatform,\n  ModuleDescriptor,\n  PackageRevision,\n  SearchOptions,\n  SearchResults,\n} from './types';\n\n/**\n * Resolves autolinking search paths. If none is provided, it accumulates all node_modules when\n * going up through the path components. This makes workspaces work out-of-the-box without any configs.\n */\nexport async function resolveSearchPathsAsync(\n  searchPaths: string[] | null,\n  cwd: string\n): Promise<string[]> {\n  return searchPaths && searchPaths.length > 0\n    ? searchPaths.map(searchPath => path.resolve(cwd, searchPath))\n    : await findDefaultPathsAsync(cwd);\n}\n\n/**\n * Finds project's package.json and returns its path.\n */\nexport async function findPackageJsonPathAsync(): Promise<string | null> {\n  return (await findUp('package.json', { cwd: process.cwd() })) ?? null;\n}\n/**\n * Looks up for workspace's `node_modules` paths.\n */\nexport async function findDefaultPathsAsync(cwd: string): Promise<string[]> {\n  const paths = [];\n  let dir = cwd;\n  let pkgJsonPath: string | undefined;\n\n  while ((pkgJsonPath = await findUp('package.json', { cwd: dir }))) {\n    dir = path.dirname(path.dirname(pkgJsonPath));\n    paths.push(path.join(pkgJsonPath, '..', 'node_modules'));\n  }\n  return paths;\n}\n\n/**\n * Searches for modules to link based on given config.\n */\nexport async function findModulesAsync(\n  platform: AutolinkingPlatform,\n  providedOptions: SearchOptions\n): Promise<SearchResults> {\n  const config = await mergeLinkingOptionsAsync(platform, providedOptions);\n  const results: SearchResults = {};\n\n  for (const searchPath of config.searchPaths) {\n    const paths = await glob('**/unimodule.json', {\n      cwd: searchPath,\n    });\n\n    for (const packageConfigPath of paths) {\n      // const packagePath = fs.realpathSync(path.join(searchPath, path.dirname(moduleConfigPath)));\n      const packagePath = path.join(searchPath, path.dirname(packageConfigPath));\n      const packageConfig = require(path.join(packagePath, 'unimodule.json'));\n      const { name, version } = require(path.join(packagePath, 'package.json'));\n\n      if (config.exclude?.includes(name) || !packageConfig.platforms?.includes(platform)) {\n        continue;\n      }\n\n      const currentRevision: PackageRevision = {\n        path: packagePath,\n        version,\n      };\n\n      if (!results[name]) {\n        // The revision that was found first will be the main one.\n        // An array of duplicates is needed only here.\n        results[name] = { ...currentRevision, duplicates: [] };\n      } else if (results[name].duplicates?.every(({ path }) => path !== packagePath)) {\n        results[name].duplicates?.push(currentRevision);\n      }\n    }\n  }\n  return results;\n}\n\n/**\n * Merges autolinking options from different sources (the later the higher priority)\n * - options defined in package.json's `expoModules` field\n * - platform-specific options from the above (e.g. `expoModules.ios`)\n * - options provided to the CLI command\n */\nexport async function mergeLinkingOptionsAsync(\n  platform: AutolinkingPlatform,\n  providedOptions: SearchOptions\n): Promise<SearchOptions> {\n  const packageJsonPath = await findPackageJsonPathAsync();\n  const packageJson = packageJsonPath ? require(packageJsonPath) : {};\n  const baseOptions = packageJson.expo?.autolinking;\n  const platformOptions = baseOptions?.[platform];\n  const allOptions: Partial<SearchOptions>[] = [providedOptions, platformOptions, baseOptions];\n\n  function pickMergedValue<T extends keyof SearchOptions>(key: T): SearchOptions[T] | null {\n    for (const obj of allOptions) {\n      if (obj?.[key]) {\n        return obj[key]!;\n      }\n    }\n    return null;\n  }\n\n  return {\n    searchPaths: await resolveSearchPathsAsync(pickMergedValue('searchPaths'), process.cwd()),\n    ignorePaths: pickMergedValue('ignorePaths'),\n    exclude: pickMergedValue('exclude'),\n  };\n}\n\n/**\n * Verifies the search results and then returns logs string, but doesn't print it yet.\n * Right now it only checks whether there are no duplicates.\n */\nexport function verifySearchResults(searchResults: SearchResults): string {\n  const cwd = process.cwd();\n  const relativePath: (pkg: PackageRevision) => string = pkg => path.relative(cwd, pkg.path);\n  const table = new Table();\n\n  for (const moduleName in searchResults) {\n    const moduleResult = searchResults[moduleName];\n\n    if (moduleResult.duplicates?.length) {\n      const duplicates = moduleResult.duplicates;\n      const paths = [\n        chalk.magenta(relativePath(moduleResult)),\n        ...duplicates.map(duplicate => chalk.gray(relativePath(duplicate))),\n      ];\n      const versions = [\n        chalk.cyan(moduleResult.version),\n        ...duplicates.map(duplicate => chalk.gray(duplicate.version)),\n      ];\n\n      table.push(\n        [\n          {\n            colSpan: 2,\n            content: `${chalk.green(moduleName)} has been found at multiple directories`,\n          },\n        ],\n        [paths.join(os.EOL), versions.join(os.EOL)]\n      );\n    }\n  }\n  if (table.length > 0) {\n    return [\n      table.toString(),\n      chalk.yellow(\n        `⚠️  Found ${table.length / 2} duplicated module(s), but only the first one will be used.`\n      ),\n      chalk.yellow(\n        '⚠️  Make sure to get rid of unnecessary versions as it may introduce some side effects.'\n      ),\n    ].join(os.EOL);\n  }\n  return '';\n}\n\n/**\n * Generates logs to print during linking.\n */\nexport function generateLogs(search: SearchResults, modules: ModuleDescriptor[]): string {\n  const logs = [\n    chalk.bold('Using Expo modules:'),\n\n    ...Object.entries(search).map(([packageName, revision]) => {\n      return `- ${chalk.green(packageName)} (${chalk.cyan(revision.version)})`;\n    }),\n\n    verifySearchResults(search),\n  ];\n  return logs.join(os.EOL);\n}\n\n/**\n * Resolves search results to a list of platform-specific configuration.\n */\nexport async function resolveModulesAsync(\n  platform: string,\n  searchResults: SearchResults\n): Promise<ModuleDescriptor[]> {\n  const platformLinking = require(`./resolvers/${platform}`);\n\n  return (\n    await Promise.all(\n      Object.entries(searchResults).map(([packageName, revision]) =>\n        platformLinking.resolveModuleAsync(packageName, revision)\n      )\n    )\n  ).filter(Boolean);\n}\n"]}